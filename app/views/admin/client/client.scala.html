@import helpers.JavaTime
@import domain._
@import domain.dao.CaseDao.Case
@import services.CaseService
@import warwick.sso.UniversityID

@import domain.dao.CaseDao.CaseRender
@(
  universityID: UniversityID,
  profile: Option[SitsProfile],
  registration: Option[Registration],
  clientSummary: Option[ClientSummary],
  enquiries: Seq[EnquiryRender],
  cases: Seq[CaseRender],
  form: Form[ClientSummarySave],
  inMentalHealthTeam: Boolean,
  success: Option[String] = None
)(implicit context: RequestContext, req: RequestHeader, messagesProvider: MessagesProvider)

@main("Client profile") {
  <h2>@profile.map(_.fullName).getOrElse(universityID.string)</h2>

  @if(form.hasErrors) {
    <div class="alert alert-danger">
      There were errors in the client summary below. Please correct them and submit again.
    </div>
  } else if (success.nonEmpty) {
    <div class="alert alert-success">
      @success.get
    </div>
  }

  @profile.map { profile =>
    <div class="row">
      @profile.photo.map { photo =>
        <div class="col-xs-5 col-sm-3 col-md-2 col-lg-2">
          <div class="photo">
            <img src="@photo" class="img-thumbnail img-circle" alt="Client photo">
          </div>
        </div>
      }
      <div class="col-xs-7 col-sm-9 col-md-10 col-lg-10">
        @profile.userType match {
          case UserType.Student => {
            <p>
              @profile.yearOfStudy.map(_.level) match {
                case Some("1") => {
                  First year
                }
                case Some("2") => {
                  Second year
                }
                case Some("3") => {
                  Third year
                }
                case Some("4") => {
                  Fourth year
                }
                case Some(level) => {
                  @{level}th year
                }
                case _ => {}
              }
              @profile.group student, @profile.department.name
            </p>
          }
          case _ => {
            <p>@profile.userType, @profile.department.name</p>
          }
        }
        <p>DoB @JavaTime.dateFullNoDayFormatter.format(profile.dateOfBirth)</p>
        <p>@profile.disability.map(_.description).getOrElse("No disabilities")</p>
        @profile.nationality.map { n =>
          <p>@n</p>
        }
        @profile.tier4VisaRequired.map { required =>
          @if(required) {
            <p>Tier 4 visa required</p>
          } else {
            <p>No Tier 4 visa required</p>
          }
        }

        @if(inMentalHealthTeam && clientSummary.exists(_.highMentalHealthRisk.contains(true))) {
          <p><span class="label label-danger">High mental health risk</span></p>
        }
        @clientSummary.flatMap(_.riskStatus).map {
          case ClientRiskStatus.Low => {
            <p><span class="label label-success">Low risk status</span></p>
          }
          case ClientRiskStatus.Medium => {
            <p><span class="label label-warning">Medium risk status</span></p>
          }
          case ClientRiskStatus.High => {
            <p><span class="label label-danger">High risk status</span></p>
          }
        }
      </div>
    </div>
  }

  <h2>Registration</h2>

  <section class="indent">

    @registration.map { registration =>
      <dl class="dl-horizontal field-history" data-href="@controllers.admin.routes.ClientController.registrationHistory(universityID)">
        <dt>Registered</dt>
        <dd>@helpers.JavaTime.Relative(registration.updatedDate)</dd>
        <dt data-field-history-field="gp">GP</dt>
        <dd>@registration.data.gp</dd>
        <dt data-field-history-field="tutor">Tutor</dt>
        <dd>@registration.data.tutor</dd>
        <dt data-field-history-field="disabilities">Disabilities</dt>
        <dd>@registration.data.disabilities.map(_.description).mkString(", ")</dd>
        <dt data-field-history-field="medications">Medication</dt>
        <dd>@registration.data.medications.map(_.description).mkString(", ")</dd>
        <dt data-field-history-field="appointmentAdjustments">Appointment adjustments</dt>
        <dd>@views.utils.nl2br(registration.data.appointmentAdjustments)</dd>
        <dt data-field-history-field="referrals">Referrals</dt>
        <dd>@registration.data.referrals.map(_.description).mkString(", ")</dd>
      </dl>
    }.getOrElse {
      <em>Client is not currently registered</em>
      @b3.inline.formCSRF(controllers.admin.routes.ClientController.invite(universityID)) { implicit ifc =>
        @b3.submit('class -> "btn btn-default") {
          Invite to register
        }
      }
    }

  </section>

  <h2>Client summary</h2>

  <section class="indent">
    @if(cases.isEmpty) {
      <p>No open or closed cases</p>
    } else {
      <p>
        @tags.p(
          number = cases.count(_.clientCase.state != IssueState.Closed),
          singular = "open case"
        )(
          plural = "open cases",
          zero = "No"
        ),
        @tags.p(
          number = cases.count(_.clientCase.state == IssueState.Closed),
          singular = "closed case"
        )(
          plural = "closed cases",
          zero = "no"
        )
        <button class="toggle-element btn btn-default btn-xs" data-target="#case-tables" data-shown-label="hide">show</button>
      </p>

      <div class="hidden" id="case-tables">
        @if(cases.exists(_.clientCase.state != IssueState.Closed )) {
          <table class="table table-condensed">
            <caption>Open cases</caption>
            <thead>
              <tr>
                <th class="col-sm-1">Case ID</th>
                <th class="col-sm-6">Subject</th>
                <th class="col-sm-3">Team</th>
                <th class="col-sm-2">Last updated</th>
              </tr>
            </thead>
            <tbody>
              @defining(cases.filter(_.clientCase.state != IssueState.Closed )) { open: Seq[CaseRender] =>
                @open.map { caseRender: CaseRender =>
                  <tr>
                    <td><a href="@controllers.admin.routes.CaseController.view(caseRender.clientCase.key.get)" target="_blank">@caseRender.clientCase.key.get.string</a></td>
                    <td><a href="@controllers.admin.routes.CaseController.view(caseRender.clientCase.key.get)" target="_blank">@caseRender.clientCase.subject</a></td>
                    <td>@caseRender.clientCase.team.name</td>
                    <td>@JavaTime.Relative(CaseService.lastModified(caseRender).toLocalDate).capitalize</td>
                  </tr>
                }
              }
            </tbody>
          </table>
        }
        @if(cases.exists(_.clientCase.state == IssueState.Closed )) {
          <table class="table table-condensed">
            <caption>Closed cases</caption>
            <thead>
              <tr>
                <th class="col-sm-1">Case ID</th>
                <th class="col-sm-6">Subject</th>
                <th class="col-sm-3">Team</th>
                <th class="col-sm-2">Closed</th>
              </tr>
            </thead>
            <tbody>
            @defining(cases.filter(_.clientCase.state == IssueState.Closed )) { closed: Seq[CaseRender] =>
              @closed.map { caseRender: CaseRender =>
                <tr>
                  <td><a href="@controllers.admin.routes.CaseController.view(caseRender.clientCase.key.get)" target="_blank">@caseRender.clientCase.key.get.string</a></td>
                  <td><a href="@controllers.admin.routes.CaseController.view(caseRender.clientCase.key.get)" target="_blank">@caseRender.clientCase.subject</a></td>
                  <td>@caseRender.clientCase.team.name</td>
                  <td>@JavaTime.Relative(caseRender.clientCase.version.toLocalDate).capitalize</td>
                </tr>
              }
            }
            </tbody>
          </table>
        }
      </div>
    }

    <p><a class="btn btn-default" href="@controllers.admin.routes.CaseController.createSelectTeam(client = Some(universityID))">Create a case</a></p>

    @* TODO List upcoming appointments *@
    <p><a class="btn btn-default" href="@controllers.admin.routes.AppointmentController.createSelectTeam(client = Some(universityID))">Create an appointment</a></p>

    @if(enquiries.isEmpty) {
      <p>No open or closed enquiries</p>
    } else {
      <p>
        @tags.p(
          number = enquiries.count { r => r.enquiry.state != IssueState.Closed },
          singular = "open enquiry"
        )(
          plural = "open enquiries",
          zero = "No"
        ),
        @tags.p(
          number = enquiries.count { r => r.enquiry.state == IssueState.Closed },
          singular = "closed enquiry"
        )(
          plural = "closed enquiries",
          zero = "no"
        )
        <button class="toggle-element btn btn-default btn-xs" data-target="#enquiry-tables" data-shown-label="hide">show</button>
      </p>

      <div class="hidden" id="enquiry-tables">
        @if(enquiries.exists { r => r.enquiry.state != IssueState.Closed }) {
          <table class="table table-condensed">
            <caption>Open enquiries</caption>
            <thead>
              <tr>
                <th class="col-sm-1">Enquiry ID</th>
                <th class="col-sm-6">Subject</th>
                <th class="col-sm-3">Team</th>
                <th class="col-sm-2">Last updated</th>
              </tr>
            </thead>
            <tbody>
              @defining(enquiries.filter { r => r.enquiry.state != IssueState.Closed }) { open: Seq[EnquiryRender] =>
                @open.map { case render =>
                  <tr>
                    <td><a href="@controllers.admin.routes.TeamEnquiryController.messages(render.enquiry.key)" target="_blank">@render.enquiry.key.string</a></td>
                    <td><a href="@controllers.admin.routes.TeamEnquiryController.messages(render.enquiry.key)" target="_blank">@render.enquiry.subject</a></td>
                    <td>@render.enquiry.team.name</td>
                    <td>@render.messages.lastOption.map { m =>
                      @JavaTime.Relative(m.message.created.toLocalDate).capitalize
                    }</td>
                  </tr>
                }
              }
            </tbody>
          </table>
        }
        @if(enquiries.exists { r => r.enquiry.state == IssueState.Closed }) {
          <table class="table table-condensed">
            <caption>Closed enquiries</caption>
            <thead>
              <tr>
                <th class="col-sm-1">Enquiry ID</th>
                <th class="col-sm-6">Subject</th>
                <th class="col-sm-3">Team</th>
                <th class="col-sm-2">Closed</th>
              </tr>
            </thead>
            <tbody>
            @defining(enquiries.filter { r => r.enquiry.state == IssueState.Closed }) { closed: Seq[EnquiryRender] =>
              @closed.map { render =>
                <tr>
                  <td><a href="@controllers.admin.routes.TeamEnquiryController.messages(render.enquiry.key)" target="_blank">@render.enquiry.key.string</a></td>
                  <td><a href="@controllers.admin.routes.TeamEnquiryController.messages(render.enquiry.key)" target="_blank">@render.enquiry.subject</a></td>
                  <td>@render.enquiry.team.name</td>
                  <td>@JavaTime.Relative(render.enquiry.lastUpdated.toLocalDate).capitalize</td>
                </tr>
              }
            }
            </tbody>
          </table>
        }
      </div>
    }

    @b3.vertical.formCSRF(controllers.admin.routes.ClientController.updateSummary(universityID)) { implicit ifc =>
      <div class="row">
        <div class="col-sm-6">
          @b3.textarea(form("notes"),
            '_label -> "Notes",
            'rows -> 5
          )
        </div>
      </div>

      <div class="row">
        <div class="col-sm-6">
          @b3.text(form("alternative-contact-number"),
            '_label -> "Alternative contact number"
          )
        </div>
        <div class="col-sm-6">
          @b3.email(form("alternative-email-address"),
            '_label -> "Alternative email address"
          )
        </div>
      </div>

      @b3.free('_label -> "Reasonable adjustments",
        '_class -> form("reasonable-adjustments").error.map(_ => "has-error").getOrElse("")
      ) {
        @ReasonableAdjustment.partioned.map { case (left, right) =>
          <div class="row checkbox-condensed">
            <div class="col-sm-6">
              @left.map { item =>
                @b3.checkbox(form(s"reasonable-adjustments[]"),
                  'id -> s"reasonable-adjustment-${item.id}",
                  'value -> item.id,
                  '_text -> item.description,
                  'checked -> form("reasonable-adjustments").indexes.exists(i => form(s"reasonable-adjustments[$i]").value.contains(item.id))
                )(b3.clear.fieldConstructorSpecific, messagesProvider)
              }
            </div>
            <div class="col-sm-6">
              @right.map { item =>
                @b3.checkbox(form(s"reasonable-adjustments[]"),
                  'id -> s"reasonable-adjustment-${item.id}",
                  'value -> item.id,
                  '_text -> item.description,
                  'checked -> form("reasonable-adjustments").indexes.exists(i => form(s"reasonable-adjustments[$i]").value.contains(item.id))
                )(b3.clear.fieldConstructorSpecific, messagesProvider)
              }
            </div>
          </div>
        }

        @form("reasonable-adjustments").error.map { error =>
          <span class="help-block">@error.format</span>
        }
      }

      <div class="row">
        <div class="col-sm-3">
          @b3.select(form("risk-status"),
            options = ("", "") +: ClientRiskStatus.values.map { s => s.entryName -> s.entryName },
            '_label -> "Risk status"
          )
        </div>
        <div class="col-sm-3 col-sm-offset-3">
          @if(inMentalHealthTeam) {
            @b3.select(form("high-mental-health-risk"), options = Seq("" -> "Not specified", "true" -> "Yes", "false" -> "No"),
              '_label -> "High mental health risk"
            )
          }
        </div>
      </div>

      @tags.submitOrCancel("Update", controllers.routes.IndexController.home())
    }
  </section>
}