@import controllers.admin.CaseController.CaseNoteFormData
@import controllers.admin.{CaseController, CaseDocumentController}
@import domain._
@import domain.CaseNoteType._
@import domain.dao.CaseDao.Case
@import domain.UserType.Student
@import helpers.JavaTime
@import org.apache.tika.mime.MediaType
@import play.api.libs.json.Json
@import warwick.sso._
@(
  c: Case.FullyJoined,
  clients: Seq[Either[UniversityID, SitsProfile]],
  owners: Seq[User],
  caseNotes: Seq[(CaseNote, Option[User])],
  sectionNotes: Map[CaseNoteType, Seq[(CaseNote, Option[User])]],
  originalEnquiry: Option[Enquiry],
  userLookup: Map[Usercode, User],
  noteForm: Form[CaseNoteFormData],
  messageForm: Form[String],
  history: CaseHistory,
  supportedMimeTypes: Seq[MediaType]
)(implicit context: RequestContext, req: RequestHeader, messagesProvider: MessagesProvider)

@caseLinks(links: Seq[CaseLink], description: CaseLinkType => String, target: CaseLink => Case) = {
  @if(links.nonEmpty) {
    <ul class="list-unstyled">
      @links.groupBy(_.linkType).map { case (linkType, l) => @l.map { link =>
        <li>
          This case @description(linkType) <a href="@controllers.admin.routes.CaseController.view(target(link).key.get)">@target(link).key.get.string</a> @target(link).subject<br />
          Link added @helpers.JavaTime.Relative(link.updatedDate) @*TODO - once CASE-195 is done add "by X in team Y"*@
          @defining(CaseController.deleteForm(link.updatedDate).fill(link.updatedDate)) { form =>
            @b3.inline.formCSRF(controllers.admin.routes.CaseController.deleteLink(c.clientCase.key.get, link.id), 'class -> "inline-form") { implicit ifc =>
              @b3.validatedHidden(form, "version")
              <button type="submit" class="btn btn-sm btn-link"><i class="fas fa-times-circle"></i></button>
            }
          }
        </li>
      }}
    </ul>
  }
}

@caseDetail(label: String)(content: Html) = {
  <div class="row form-horizontal">
    <div class="col-sm-5 control-label">
      @label
    </div>
    <div class="col-sm-7">
      <div class="form-control-static">
        @content
      </div>
    </div>
  </div>
}

@collapsibleSection(label: String)(content: Html) = {
  <details class="case-details--section row form-horizontal">
    <summary class="control-label">@label <i class="closed fas fa-plus-circle"></i> <i class="open fas fa-minus-circle"></i></summary>
    <div class="content form-control-static">
      @content
    </div>
  </details>
}

@section(label: String)(content: Html) = {
  <div class="case-details--section row form-horizontal">
    <div class="control-label">@label</div>
    <div class="content form-control-static">
      @content
    </div>
  </div>
}

@caseNote(note: CaseNote, user: Option[User]) = {
  <div class="panel panel-default">
    <div class="panel-heading">
      <h3 class="panel-title">
        <span class="date pull-right">
          @helpers.JavaTime.Relative(note.created)
          @if(note.lastUpdated != note.created) {
            (last updated @helpers.JavaTime.Relative(note.lastUpdated))
          }
        </span>
        @{note.noteType.description}
      </h3>
    </div>
    <div class="panel-body">
    @views.utils.nl2br(note.text)
    </div>
    <div class="panel-footer">
      <div class="pull-right">
        <a class="btn btn-default btn-xs" href="@controllers.admin.routes.CaseController.editNoteForm(c.clientCase.key.get, note.id)">Edit</a>
        @defining(CaseController.deleteForm(note.lastUpdated).fill(note.lastUpdated)) { form =>
          @b3.inline.formCSRF(controllers.admin.routes.CaseController.deleteNote(c.clientCase.key.get, note.id), 'class -> "inline-form") { implicit ifc =>
            @b3.validatedHidden(form, "version")
            <button type="submit" class="btn btn-default btn-xs">Delete</button>
          }
        }
      </div>
      <div class="author">@user.flatMap(_.name.full).getOrElse(s"[unknown user ${note.teamMember.string}]")</div>
    </div>
  </div>
}

@viewSectionNotes(noteType: CaseNoteType, link: String) = {
  @defining(sectionNotes.getOrElse(noteType, Nil)) { notes: Seq[(CaseNote, Option[User])] =>
    @if(notes.nonEmpty) {
      <a role="button" href="#@noteType.entryName-notes-modal" data-toggle="modal" data-target="#@noteType.entryName-notes-modal">
        View @tags.p(notes.size, link)()
      </a>

      <div class="modal fade" id="@noteType.entryName-notes-modal" tabindex="-1" role="dialog" aria-labelledby="@noteType.entryName-notes-modal-label">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
              <h4 class="modal-title" id="@noteType.entryName-notes-modal-label">@{link.capitalize}s</h4>
            </div>
            <div class="modal-body">
              @notes.map { case (note, user) => @caseNote(note, user) }
            </div>
          </div>
        </div>
      </div>
    }
  }
}

@main(s"${c.clientCase.key.get.string} ${c.clientCase.subject}") {
  <div class="case-details">
    <div class="case-details--header">
      @clients.map {
        case Left(universityID) => {
          <h5><a href="@controllers.admin.routes.ClientController.client(universityID)">@universityID.string</a></h5>
        }
        case Right(profile) => {
          <h5>
            <a href="@controllers.admin.routes.ClientController.client(profile.universityID)">@profile.fullName</a>,
            @profile.universityID.string,
            @views.tags.profiles.typeAndDepartment(profile)
          </h5>
        }
      }
    </div>
    <div class="case-details--actions row">
      <div class="col-sm-6 col-md-5 field-history" data-field-history="@Json.stringify(Json.toJson(history)(CaseHistory.writer))">

        @caseDetail("Date raised"){ <div>@helpers.JavaTime.Relative(c.clientCase.created)</div> }

        @caseDetail("Team"){
          <div data-field-history-field="team">@c.clientCase.team.name</div>
          @viewSectionNotes(Referral, "team assignment note")
        }

        @caseDetail("State"){ <div data-field-history-field="state">@c.clientCase.state</div> }

        @if(c.clientCase.incidentDate.nonEmpty) {
          @* If currently related to an incident... *@
          @caseDetail("Incident"){
            <span data-field-history-field="incidentDate">@helpers.JavaTime.Relative(c.clientCase.incidentDate.get)</span>
            <span data-field-history-field="onCampus">@if(c.clientCase.onCampus.contains(true)) { On-campus } else { Off-campus }</span>
            @if(c.clientCase.notifiedPolice.contains(true)) {
              <span data-field-history-field="notifiedPolice">
                <span class="label label-info">Police notified</span>
              </span>
            } else if (history.notifiedPolice.exists(_._1.contains(true))) {
              <span data-field-history-field="notifiedPolice">
                <span class="label label-info"><s>Police notified</s></span>
              </span>
            }

            @if(c.clientCase.notifiedAmbulance.contains(true)) {
              <span data-field-history-field="notifiedAmbulance">
                <span class="label label-info">Ambulance called</span>
              </span>
            } else if (history.notifiedAmbulance.exists(_._1.contains(true))) {
            <span data-field-history-field="notifiedAmbulance">
              <span class="label label-info"><s>Ambulance called</s></span>
            </span>
            }

            @if(c.clientCase.notifiedFire.contains(true)) {
              <span data-field-history-field="notifiedFire">
                <span class="label label-info">Fire service called</span>
              </span>
            } else if (history.notifiedFire.exists(_._1.contains(true))) {
            <span data-field-history-field="notifiedFire">
              <span class="label label-info"><s>Fire service called</s></span>
            </span>
            }
          }
        } else if(history.incidentDate.exists(_._1.nonEmpty)) {
          @* If not currently related to an incident but was previously... *@
          @caseDetail("Incident"){
            <span data-field-history-field="incidentDate">Not currently related to an incident</span>
          }
        }

        @originalEnquiry.map { enquiry => @caseDetail("Original enquiry"){
            <a href="@controllers.admin.routes.TeamEnquiryController.messages(enquiry.key.get)">@enquiry.key.get.string @enquiry.subject</a>
            -
            @helpers.JavaTime.Relative(enquiry.created)
        }}

        @caseDetail("Cause"){ <div data-field-history-field="cause">@c.clientCase.cause.description</div> }

        @c.clientCase.caseType.map { caseType => @caseDetail("Case type"){
            <div data-field-history-field="caseType">@caseType.description</div>
        }}

        @if(c.tags.nonEmpty || history.tags.size > 1) {
          @caseDetail("Tags"){
            <div data-field-history-field="tags">
              @if(c.tags.nonEmpty) {
                @c.tags.toSeq.map(_.description).sorted.mkString(", ")
              } else {
                None
              }
            </div>
          }
        }

        @tags.manageOwners(
          owners,
          controllers.admin.routes.OwnersController.caseSubmit(c.clientCase.key.get),
          controllers.admin.routes.OwnersController.caseSubmitSelf(c.clientCase.key.get),
          labelCols = 5,
          containerCols = 7
        )

      </div>
      <div class="col-sm-6 col-md-4 col-md-offset-2">
        <div class="row form-horizontal">
          <div class="col-sm-4 control-label">
            Actions
          </div>
          <div class="col-sm-8">
            <p>
              @if(c.clientCase.state != IssueState.Closed) {
                <a href="@controllers.admin.routes.CaseController.closeForm(c.clientCase.key.get)" class="btn btn-primary btn-block">Close case</a>
              } else {
                <a href="@controllers.admin.routes.CaseController.closeForm(c.clientCase.key.get)" class="btn btn-primary btn-block">Reopen case</a>
              }
            </p>
            <p>
              <a href="@controllers.admin.routes.CaseController.editForm(c.clientCase.key.get)" class="btn btn-default btn-block">Edit case</a>
            </p>
            <p>
              <a href="@controllers.admin.routes.CaseDocumentController.addDocumentForm(c.clientCase.key.get)" class="btn btn-default btn-block">Add a document</a>
            </p>
            <p>
              <a href="@controllers.admin.routes.CaseController.linkForm(c.clientCase.key.get)" class="btn btn-default btn-block">Link to another case</a>
            </p>
            <p>
              <a href="@controllers.admin.routes.CaseController.reassign(c.clientCase.key.get)" class="btn btn-default btn-block">Assign to a different team</a>
            </p>
          </div>
        </div>
      </div>
    </div>

    @if(c.outgoingCaseLinks.nonEmpty ||  c.incomingCaseLinks.nonEmpty){
      @collapsibleSection("Case links") {
        @caseLinks(c.outgoingCaseLinks, _.outwardDescription, _.incoming)
        @caseLinks(c.incomingCaseLinks, _.inwardDescription, _.outgoing)
        @viewSectionNotes(AssociatedCase, "case links note")
      }
    }

    @if(c.documents.nonEmpty) {
      @collapsibleSection("Documents") {
        <table class="table table-default">
          <thead>
            <tr>
              <th class="col-sm-4">Document type</th>
              <th class="col-sm-4">File</th>
              <th class="col-sm-3">Created</th>
              <th class="col-sm-1"></th>
            </tr>
          </thead>
          <tbody>
          @c.documents.map { doc =>
            <tr>
              <td>@doc.documentType.description</td>
              <td>
                <a href="@controllers.admin.routes.CaseDocumentController.download(c.clientCase.key.get, doc.id)">@doc.file.fileName</a>
              </td>
              <td>@helpers.JavaTime.Relative(doc.created)</td>
              <td>
              @defining(CaseDocumentController.deleteForm(doc.lastUpdated).fill(doc.lastUpdated)) { form =>
                @b3.inline.formCSRF(controllers.admin.routes.CaseDocumentController.delete(c.clientCase.key.get, doc.id), 'class -> "inline-form") { implicit ifc =>
                  @b3.validatedHidden(form, "version")
                  <button type="submit" class="btn btn-default btn-xs">Delete</button>
                }
              }
              </td>
            </tr>
          }
          </tbody>
        </table>
        @viewSectionNotes(DocumentNote, "document note")
      }
    }

    @collapsibleSection("Case notes") {

      @if(c.clientCase.state != IssueState.Closed) {
        @b3.vertical.formCSRF(controllers.admin.routes.CaseController.addNote(c.clientCase.key.get)) { implicit ifc =>
          <div class="panel panel-default panel-form">
            <div class="panel-heading">
              <h3 class="panel-title">Add a case note</h3>
            </div>
            <div class="panel-body">
              @b3.validatedHidden(noteForm, "version")
              @b3.textarea(noteForm("text"), 'rows -> 5)
            </div>
            <div class="panel-footer">
              <button type="submit" class="btn btn-primary">Save</button>
            </div>
          </div>
        }
      }

      @caseNotes.map { case (note, user) => @caseNote(note, user)}
    }

    @collapsibleSection("Appointments") {
      <p><a href="@controllers.admin.routes.AppointmentController.createForm(c.clientCase.team.id, forCase = Some(c.clientCase.key.get))" class="btn btn-default">Create an appointment</a></p
    }

    @section("Messages") {
      <div class="panel-group" id="messages-accordion" role="tablist" aria-multiselectable="true">
      @clients.map { maybeClient =>
        @defining(SitsProfile.universityId(maybeClient)) { universityId: UniversityID =>
          @defining(c.messages.byClient.getOrElse(universityId, Nil)) { messages: Seq[MessageRender] =>
            <div class="thread panel panel-default">
              <div class="panel-heading" role="tab" id="thread-heading-@universityId.string">
                <h4 class="panel-title">
                @if(clients.size > 1){
                  <a class="collapsed" role="button" data-toggle="collapse" data-parent="#enquiries-accordion" href="#collapse-thread-@universityId.string" aria-expanded="true" aria-controls="collapse-thread-@universityId">
                    <div class="pull-right">
                      @messages.lastOption.map { m =>
                        @JavaTime.Relative(m.message.created)
                      }
                      <i class="fas fa-fw fa-angle-down"></i>
                      <i class="fas fa-fw fa-angle-up"></i>
                    </div>
                    @tags.clientFullName(maybeClient)
                    @if(messages.isEmpty) {
                      (No messages)
                    } else {
                      (@tags.p(messages.length, "message")())
                    }
                  </a>
                } else {
                  <div class="pull-right">
                  @messages.lastOption.map { m =>
                    @JavaTime.Relative(m.message.created)
                  }
                  </div>
                  @if(messages.isEmpty) {
                    No messages
                  } else {
                    @tags.p(messages.length, "message")()
                  }
                }

                </h4>
              </div>
              <div id="collapse-thread-@universityId.string" class="panel-collapse @if(clients.size > 1){ collapse }" role="tabpanel" aria-labelledby="thread-heading-@universityId.string">
                <div class="panel-body">
                  @messages.map { render =>
                    @views.html.tags.messages.message(
                      render.message,
                      render.files,
                      "Client",
                      render.message.teamMember
                          .flatMap { usercode =>
                        userLookup.get(usercode)
                            .filter(_.isFound)
                            .flatMap(_.name.full)
                            .map { name => s"$name, ${render.message.team.getOrElse(c.clientCase.team).name} team" }
                      }.getOrElse(s"${render.message.team.getOrElse(c.clientCase.team).name} team"),
                      f => controllers.admin.routes.CaseMessageController.download(c.clientCase.key.get, f.id),
                      // TODO last view date for cases
                      None
                    )

                    @*if(render.message.sender == MessageSender.Client) {
                      <div class="message message-client">
                        <div class="date pull-right">@helpers.JavaTime.Relative(render.message.created)</div>
                        <div class="message--author">Client</div>
                        @views.utils.nl2br(render.message.text)
                      </div>
                    } else {
                      <div class="message message-team">
                        <div class="date pull-right">@helpers.JavaTime.Relative(render.message.created)</div>
                        <div class="message--author">@render.message.teamMember.flatMap(userLookup.get).map(_.name.full).getOrElse("Team member")</div>
                        @views.utils.nl2br(render.message.text)
                      </div>
                    }*@
                  }
                </div>
                <div class="panel-footer">
                @if(c.clientCase.state != IssueState.Closed) {
                  @tags.messages.messageForm(controllers.admin.routes.CaseMessageController.addMessage(c.clientCase.key.get, universityId), messageForm, supportedMimeTypes)
                }
                </div>
              </div>
            </div>
          }
        }
      }
      </div>
    }

  </div>
}