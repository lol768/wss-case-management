@import domain.{Case, Client, ClientConsultation, ClientConsultationSave}
@import warwick.core.helpers.JavaTime
@import warwick.sso.UniversityID
@import domain.Member
@import warwick.sso.Usercode

@(
  c: Case,
  clients: Set[Client],
  consultations: Map[UniversityID, (Seq[(ClientConsultation, Form[ClientConsultationSave])], Form[ClientConsultationSave])],
  teamMemberLookup: Map[Usercode, Member]
)(implicit context: RequestContext, req: RequestHeader, messagesProvider: MessagesProvider)

@renderConsultation(client: Client, consultation: Option[ClientConsultation], form: Form[ClientConsultationSave], collapsed: Boolean) = {
  <div class="consultations__consultation panel panel-default">
    @b3.vertical.formCSRF(consultation.map(cons => controllers.admin.routes.ClientConsultationController.editForCase(c.key, client.universityID, cons.id)).getOrElse(controllers.admin.routes.ClientConsultationController.createForCase(c.key, client.universityID))) { implicit ifc =>
      <div class="panel-heading" role="tab" id="consultation-heading-@client.universityID.string-@{consultation.map(_.id.toString).getOrElse("new")}">
        <h4 class="panel-title">
          @if(collapsed){
            <a class="collapsed" role="button" data-toggle="collapse" data-parent="#consultations-accordion" href="#collapse-consultation-@client.universityID.string-@{consultation.map(_.id.toString).getOrElse("new")}" aria-expanded="true" aria-controls="collapse-consultation-@client.universityID.string-@{consultation.map(_.id.toString).getOrElse("new")}">
              <div class="pull-right consultations__consultation__updatedDate">
                @consultation.map { c =>
                  @JavaTime.Relative(c.updatedDate)
                  (recorded by @{teamMemberLookup.get(c.updatedBy).map(_.safeFullName).getOrElse(c.updatedBy.string)})
                }
                <i class="fas fa-fw fa-angle-down"></i>
                <i class="fas fa-fw fa-angle-up"></i>
              </div>
              @client.safeFullName
              @if(consultation.isEmpty){(<span class="consultations__consultation__title">New consultation</span>)}
            </a>
          } else {
            <div class="pull-right consultations__consultation__updatedDate">
              @consultation.map { c =>
                @JavaTime.Relative(c.updatedDate)
                (recorded by @{teamMemberLookup.get(c.updatedBy).map(_.safeFullName).getOrElse(c.updatedBy.string)})
              }
            </div>
            <span class="consultations__consultation__title">
              Consultation with @client.safeFullName
            </span>
          }
        </h4>
      </div>
      <div id="collapse-consultation-@client.universityID.string-@{consultation.map(_.id.toString).getOrElse("new")}" class="panel-collapse @if(collapsed){ collapse }" role="tabpanel" aria-labelledby="consultation-heading-@client.universityID.string-@{consultation.map(_.id.toString).getOrElse("new")}">
        <div class="panel-body">
          @views.html.admin.client.consultationFormFields(form)
        </div>
        <div class="panel-footer">
          <button type="submit" class="btn btn-primary">Save</button>
        </div>
      </div>
    }
  </div>
}

<div class="panel-group consultations" id="consultations-accordion" role="tablist" aria-multiselectable="true" data-count="@consultations.values.flatMap(_._1).size">
  @clients.toSeq.sorted.map { client =>
    @defining(consultations(client.universityID)) { case (cons: Seq[(ClientConsultation, Form[ClientConsultationSave])], createForm: Form[ClientConsultationSave]) => {
      @cons.zipWithIndex.map { case ((consultation: ClientConsultation, form: Form[ClientConsultationSave]), i: Int) => {
        @renderConsultation(client, Some(consultation), form, collapsed = (i != cons.size - 1))
      }}

      @renderConsultation(client, None, createForm, collapsed = (cons.nonEmpty || clients.size > 1))
    }}
  }
</div>
