@import controllers.admin.AppointmentController.CancelAppointmentData
@import domain.{AppointmentCancellationReason, AppointmentClient, AppointmentRender, AppointmentState, SitsProfile}
@import warwick.sso.{UniversityID, User, Usercode}
@(
  a: AppointmentRender,
  clients: Seq[(AppointmentClient, Either[UniversityID, SitsProfile])],
  userLookup: Map[Usercode, User],
  cancelForm: Form[CancelAppointmentData],
)(implicit context: RequestContext, req: RequestHeader, messagesProvider: MessagesProvider)

@main(s"${a.appointment.key.string} ${a.appointment.subject}") {
  <div class="row">
    <div class="col-md-4 col-md-push-8">
      @clients.map { case (client, p) =>
        @p match {
          case Left(universityID) => {
            <div>
              <p>
                <strong>University ID: </strong> <a href="@controllers.admin.routes.ClientController.client(universityID)">@universityID.string</a>
                @tags.appointments.clientAppointmentState(a.appointment, client)
              </p>
            </div>
          }
          case Right(profile) => {
            <div class="row">
              @profile.photo.map { photo =>
                <div class="col-sm-4">
                  <p class="photo">
                    <a href="@controllers.admin.routes.ClientController.client(profile.universityID)">
                      <img src="@photo" class="img-thumbnail img-circle">
                    </a>
                  </p>
                </div>
              }
              <div class="col-sm-8">
                <p>
                  <strong>University ID: </strong> <a href="@controllers.admin.routes.ClientController.client(profile.universityID)">@profile.universityID.string</a><br />
                  <strong>Full name: </strong> @profile.fullName<br />
                  <strong>Department: </strong> @profile.department.name<br />
                  <strong>Warwick email address: </strong> @profile.warwickEmail<br />
                  @tags.appointments.clientAppointmentState(a.appointment, client)
                </p>
              </div>
            </div>
          }
        }
      }
    </div>
    <div class="col-md-8 col-md-pull-4"> @* TODO history *@
      <dl class="dl-horizontal">
        <dt>Date/time</dt>
        <dd>@helpers.JavaTime.Relative(a.appointment.start) &ndash; @a.appointment.end.format(java.time.format.DateTimeFormatter.ofPattern("HH:mm"))</dd>

        @a.appointment.location.map { loc =>
          <dt>Location</dt>
          <dd>@loc.name</dd> @* TODO campus map link *@
        }

        <dt>Team member</dt>
        <dd>@userLookup.get(a.appointment.teamMember).flatMap(_.name.full).getOrElse(s"Unknown (${a.appointment.teamMember.string})")</dd>

        <dt>Team</dt>
        <dd>@a.appointment.team.name team</dd>

        <dt>Appointment type</dt>
        <dd>@a.appointment.appointmentType.description</dd>

        @a.clientCase.map { clientCase =>
          <dt>Case</dt>
          <dd><a href="@controllers.admin.routes.CaseController.view(clientCase.key.get)">@clientCase.key.get.string @clientCase.subject</a></dd>
        }

        <dt>State</dt>
        <dd>
          <span class="label label-@a.appointment.state.labelType" @a.appointment.cancellationReason.map { r => title="@r.description" }>
            @tags.icons.appointmentState(a.appointment.state)
            @a.appointment.state
          </span>

          @if(a.appointment.state == AppointmentState.Provisional || a.appointment.state == AppointmentState.Confirmed) {
            &nbsp;
            @b3.horizontal.formCSRF(controllers.admin.routes.AppointmentController.cancel(a.appointment.key), "col-sm-3", "col-sm-9", 'class -> "inline-form") { implicit ifc =>
              <button type="button" class="btn btn-default btn-xs" data-toggle="modal" data-target="#cancel-modal">@tags.icons.appointmentCancel() Cancel</button>

              @b3.validatedHidden(cancelForm, "version")

              <div class="modal fade" id="cancel-modal" tabindex="-1" role="dialog" aria-labelledby="cancel-modal-label">
                <div class="modal-dialog" role="document">
                  <div class="modal-content">
                    <div class="modal-header">
                      <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                      <h4 class="modal-title" id="cancel-modal-label">Cancel appointment</h4>
                    </div>
                    <div class="modal-body form-vertical">
                    @b3.select(cancelForm("cancellationReason"),
                      options = AppointmentCancellationReason.values.map { r => r.entryName -> r.description },
                      '_label -> "Reason",
                      '_default -> "",
                      'required -> true
                    )
                    </div>
                    <div class="modal-footer spaced-buttons">
                      <button type="submit" class="btn btn-primary">Cancel appointment</button>
                      <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                    </div>
                  </div>
                </div>
              </div>
            }
          }
        </dd>

        @a.appointment.cancellationReason.map { reason =>
          <dt>Cancellation reason</dt>
          <dd>@reason.description</dd>
        }
      </dl>

      <p>
        <a class="btn btn-default" href="@controllers.admin.routes.AppointmentController.editForm(a.appointment.key)">Edit appointment</a>
      </p>
    </div>
  </div>
}