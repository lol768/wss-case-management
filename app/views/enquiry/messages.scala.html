@import domain.{Enquiry, IssueState, MessageRender, SitsProfile}
@import helpers.JavaTime
@import org.apache.tika.mime.MediaType

@(
  enquiry: Enquiry,
  client: Option[SitsProfile],
  messages: Seq[MessageRender],
  f: Form[String],
  supportedMimeTypes: Seq[MediaType],
)(implicit context: RequestContext, req: RequestHeader, messagesProvider: MessagesProvider)

@main(s"${enquiry.team.name} enquiry from ${client.map { c => s"${c.fullName} (${enquiry.universityID.string})" }.getOrElse(enquiry.universityID.string)}") {
  <h2>
    <div class="pull-right">
      @if(enquiry.version.isAfter(messages.last.message.created)) {
        @JavaTime.Relative(enquiry.version)
      } else {
        @JavaTime.Relative(messages.last.message.created)
      }
    </div>
    @tags.icons.enquiryState(enquiry.state)
    @enquiry.subject
  </h2>
  <div class="thread thread--client panel panel-default">
    <div class="panel-body">
      @messages.map { message =>
        @views.html.tags.messages.message(message.message, message.files, "You", s"${message.message.team.getOrElse(enquiry.team).name} team", f => controllers.enquiries.routes.EnquiryMessagesController.download(enquiry.key.get, f.id))
      }
    </div>
    <div class="panel-footer">
      @if(enquiry.state != IssueState.Closed) {
        @tags.messages.messageForm(controllers.enquiries.routes.EnquiryMessagesController.addMessage(enquiry.key.get), f, supportedMimeTypes)
      }
    </div>
  </div>
}