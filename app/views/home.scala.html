@import java.time.OffsetDateTime
@import java.util.UUID

@import controllers.IndexController.{ClientInformation, TeamMemberInformation}
@import controllers.RequestContext
@import domain.dao.CaseDao.Case
@import domain.{Enquiry, EnquiryRender, MessageData, Registration, SitsProfile}
@import helpers.JavaTime
@import warwick.sso.UniversityID

@(
  clientInformation: ClientInformation,
  teamMemberInformation: Option[TeamMemberInformation],
)(implicit request: RequestHeader, messagesProvider: MessagesProvider, context: RequestContext)

@renderClientInformation(enquiries: Seq[EnquiryRender], registration: Option[Registration]) = {
  <div class="pull-right">
    <a href="@controllers.registration.routes.RegisterController.form()" class="btn btn-default">
      @if(registration.isDefined) {
        View and update registration
      } else {
        Register
      }
    </a>
  </div>

  <p>If you have a question or would like to arrange to speak to somebody about an issue:</p>
  <a class="btn btn-primary" href="@controllers.enquiries.routes.EnquiryController.form()">
    @if(enquiries.isEmpty) {
      Make an enquiry
    } else {
      Make another enquiry
    }
  </a>

  @if(enquiries.nonEmpty) {
    <h2>Your enquiries</h2>

    <div class="panel-group enquiries" id="enquiries-accordion" role="tablist" aria-multiselectable="true">
      @enquiries.map { e =>
        <div class="panel panel-default enquiry enquiry--client state-@e.enquiry.state.entryName">

          <div class="panel-heading" role="tab" id="heading-@e.enquiry.key.get.string">
            <h4 class="panel-title">
                <a class="@if(enquiries.head.enquiry != e.enquiry){collapsed}" role="button" data-toggle="collapse" data-parent="#enquiries-accordion" href="#collapse-@e.enquiry.key.get.string" aria-expanded="true" aria-controls="collapse-@e.enquiry.key.get.string">
                <div class="pull-right">
                  @if(e.enquiry.version.isAfter(e.messages.last.message.created)) {
                    @JavaTime.Relative(e.enquiry.version)
                  } else {
                    @JavaTime.Relative(e.messages.last.message.created)
                  }
                  <i class="fas fa-fw fa-angle-down"></i>
                  <i class="fas fa-fw fa-angle-up"></i>
                </div>
                @tags.icons.enquiryState(e.enquiry.state)
                @e.enquiry.subject
              </a>
            </h4>
          </div>

          <div id="collapse-@e.enquiry.key.get.string" class="panel-collapse collapse @if(enquiries.head.enquiry == e.enquiry){in}" role="tabpanel" aria-labelledby="heading-@e.enquiry.key.get.string" data-ping="@controllers.enquiries.routes.EnquiryMessagesController.auditView(e.enquiry.key.get)">
            <div class="panel-body">
              @e.messages.map { render =>
                @views.html.enquiry.enquiryMessage(e.enquiry, render.message, render.files, clientName = "You", s"${render.message.team.getOrElse(e.enquiry.team).name} team", f => controllers.enquiries.routes.EnquiryMessagesController.download(e.enquiry.key.get, f.id))
              }
            </div>
              <div class="panel-footer">
                @b3.inline.formCSRF(controllers.enquiries.routes.EnquiryMessagesController.addMessage(e.enquiry.key.get), 'enctype -> "multipart/form-data") { implicit ifc =>
                  <div class="form-group">
                    <label for="textarea-@e.enquiry.key.get.string">
                      Add a message
                    </label>
                    <div class="flex">
                      <textarea id="textarea-@e.enquiry.key.get.string" class="form-control" rows="1" name="text"></textarea>

                      @* Styling TBC *@
                      <input type="file" name="file" class="form-control" multiple>

                      @tags.messages.sendButton()
                    </div>
                  </div>
                  <div class="alert alert-danger hidden"></div>
              </div>
            }
          </div>
        </div>
      }
    </div>
  }
}

@if(teamMemberInformation.isEmpty) {
  @main("My enquiries", hidePageTitle = true) {
    @renderClientInformation(clientInformation.enquiries, clientInformation.registration)
  }
} else {
  @teamMemberInformation.map { info =>
    @main(s"${context.user.flatMap(_.name.full).get}${if(info.teams.size == 1) s", ${info.teams.head.name} team" else ""}") {
      <h4>Enquiries, cases and appointments assigned to me</h4>

      <ul class="nav nav-tabs" role="tablist">
        <li role="presentation" class="active">
          <a href="#enquiries" aria-controls="enquiries" role="tab" data-toggle="tab">@tags.icons.enquiries() Enquiries</a>
        </li>
        <li role="presentation">
          <a href="#cases" aria-controls="cases" role="tab" data-toggle="tab">@tags.icons.cases() Cases</a>
        </li>
        <li role="presentation">
          <a href="#clients" aria-controls="clients" role="tab" data-toggle="tab">@tags.icons.clients() Clients</a>
        </li>
        <li role="presentation">
          <a href="#appointments" aria-controls="appointments" role="tab" data-toggle="tab">@tags.icons.appointments() Appointments</a>
        </li>
        <li role="presentation">
          <a href="#me" aria-controls="me" role="tab" data-toggle="tab">@tags.icons.myEnquiries() My enquiries</a>
        </li>
      </ul>

      <div class="tab-content">
        <div role="tabpanel" class="tab-pane active" id="enquiries">
          @views.html.admin.enquiriesTab(info.enquiriesRequiringAction, info.enquiriesAwaitingClient, info.closedEnquiries, info.clients, routes.IndexController.closedEnquiries)
        </div>
        <div role="tabpanel" class="tab-pane" id="cases">
          @views.html.admin.casesTab(info.openCases, info.closedCases, info.clients, controllers.admin.routes.CaseController.createSelectTeam(None, None), routes.IndexController.closedCases)
        </div>
        <div role="tabpanel" class="tab-pane" id="clients">
          @views.html.admin.clientsTab()
        </div>
        <div role="tabpanel" class="tab-pane" id="appointments">
          @views.html.admin.appointmentsTab()
        </div>
        <div role="tabpanel" class="tab-pane" id="me">
          @renderClientInformation(clientInformation.enquiries, clientInformation.registration)
        </div>
      </div>
    }
  }
}