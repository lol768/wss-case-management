@import domain.{EnquiryRender, IssueState, Registration}
@import helpers.JavaTime

@(
  teams: Seq[domain.Team],
  enquiries: Seq[EnquiryRender],
  registration: Option[Registration]
)(implicit context: RequestContext, req: RequestHeader)

@main("Home") {
  <div class="pull-right">
    <a href="@controllers.registration.routes.RegisterController.form()" class="btn btn-default">
      @if(registration.isDefined) {
        View and update registration
      } else {
        Register
      }
    </a>
  </div>


  <p>If you have a question or would like to arrange to speak to somebody about an issue:</p>
  <a class="btn btn-primary" href="@controllers.enquiries.routes.EnquiryController.form()">
    @if(enquiries.isEmpty) {
      Make an enquiry
    } else {
      Make another enquiry
    }
  </a>

  @if(enquiries.nonEmpty) {
    <h2>Your enquiries</h2>

    <div class="panel-group enquiries" id="enquiries-accordion" role="tablist" aria-multiselectable="true">
      @enquiries.map { e =>
        <div class="panel panel-default enquiry enquiry--client state-@e.enquiry.state.entryName">

          <div class="panel-heading" role="tab" id="heading-@e.enquiry.key.get.string">
            <h4 class="panel-title">
                <a class="@if(enquiries.head.enquiry != e.enquiry){collapsed}" role="button" data-toggle="collapse" data-parent="#enquiries-accordion" href="#collapse-@e.enquiry.key.get.string" aria-expanded="true" aria-controls="collapse-@e.enquiry.key.get.string">
                <div class="pull-right">
                  @if(e.enquiry.version.isAfter(e.messages.last.message.created)) {
                    @JavaTime.Relative(e.enquiry.version)
                  } else {
                    @JavaTime.Relative(e.messages.last.message.created)
                  }
                  <i class="fas fa-fw fa-angle-down"></i>
                  <i class="fas fa-fw fa-angle-up"></i>
                </div>
                @tags.icons.enquiryState(e.enquiry.state)
                @e.enquiry.subject
              </a>
            </h4>
          </div>

          <div id="collapse-@e.enquiry.key.get.string" class="panel-collapse collapse @if(enquiries.head.enquiry == e.enquiry){in}" role="tabpanel" aria-labelledby="heading-@e.enquiry.key.get.string" data-ping="@controllers.enquiries.routes.EnquiryMessagesController.auditView(e.enquiry.key.get)">
            <div class="panel-body">
              @e.messages.map { render =>
                @views.html.enquiry.enquiryMessage(e.enquiry, render.message, render.files, clientName = "You", s"${render.message.team.getOrElse(e.enquiry.team).name} team", f => controllers.enquiries.routes.EnquiryMessagesController.download(e.enquiry.key.get, f.id))
              }
            </div>
              <div class="panel-footer">
                @b3.inline.formCSRF(controllers.enquiries.routes.EnquiryMessagesController.addMessage(e.enquiry.key.get), 'enctype -> "multipart/form-data") { implicit ifc =>
                  <div class="form-group">
                    <label for="textarea-@e.enquiry.key.get.string">
                      Add a message
                    </label>
                    <div class="flex">
                      <textarea id="textarea-@e.enquiry.key.get.string" class="form-control" rows="1" name="text"></textarea>

                      @* Styling TBC *@
                      <input type="file" name="file" class="form-control" multiple>

                      @tags.messages.sendButton()
                    </div>
                  </div>
                  <div class="alert alert-danger hidden"></div>
              </div>
            }
          </div>
        </div>
      }
    </div>
  }
}