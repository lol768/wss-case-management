@import domain.{Enquiry, IssueRender, MessageSender, Registration}
@import domain.dao.CaseDao.Case
@import org.apache.tika.mime.MediaType
@import play.api.data.Forms._
@import warwick.core.helpers.JavaTime
@import domain.IssueState

@(issues: Seq[IssueRender], registration: Option[Registration], supportedMimeTypes: Seq[MediaType])(implicit request: RequestHeader, messagesProvider: MessagesProvider, context: RequestContext)

@registration.map { r =>
  <div class="pull-right">
    <a href="@controllers.registration.routes.RegisterController.form()" class="btn btn-default">
      @if(r.data.nonEmpty) {
        View and update registration
      } else {
        Register
      }
    </a>
  </div>
}

<p>If you have a question or would like to arrange to speak to somebody about an issue:</p>
<a class="btn btn-primary" href="@controllers.enquiries.routes.EnquiryController.form()">
@if(issues.isEmpty) {
  Make an enquiry
} else {
  Make another enquiry
}
</a>

@if(issues.nonEmpty) {
  <h2>Your messages</h2>

  <div class="panel-group message-threads" id="enquiries-accordion" role="tablist" aria-multiselectable="true">
  @issues.map { issueRender: IssueRender =>
    <div class="panel panel-default thread thread--client state-@issueRender.issue.state.entryName">

      <div class="panel-heading" role="tab" id="heading-@issueRender.issue.id.get.toString">
        <h4 class="panel-title">
          <a class="@if(issues.head.issue != issueRender.issue){collapsed}" role="button" data-toggle="collapse" data-parent="#enquiries-accordion" href="#collapse-@issueRender.issue.id.get.toString" aria-expanded="true" aria-controls="collapse-@issueRender.issue.id.get.toString">
            <div class="pull-right">
              @JavaTime.Relative(issueRender.lastUpdatedDate)
              <i class="fas fa-fw fa-angle-down"></i>
              <i class="fas fa-fw fa-angle-up"></i>
            </div>
            @tags.icons.enquiryState(issueRender.issue.state, issueRender.messages.last.message, MessageSender.Client)
            @issueRender.issue match {
              case e: Enquiry => {
                @e.subject
              }
              case c: Case => {
                Enquiry
              }
              case _ => {}
            }
          </a>
        </h4>
      </div>

      <div id="collapse-@issueRender.issue.id.get.toString" class="panel-collapse collapse @if(issues.head.issue == issueRender.issue){in}" role="tabpanel" aria-labelledby="heading-@issueRender.issue.id.get.toString" data-ping="@controllers.routes.ClientMessagesController.auditView(issueRender.issue.id.get)">
        <div class="panel-body">
          @issueRender.messages.map { render =>
            @views.html.tags.messages.message(
              message = render.message,
              files = render.files,
              clientName = "You",
              teamName = render.message.team.getOrElse(issueRender.issue.team).name,
              attachmentRoute = f => controllers.routes.ClientMessagesController.download(issueRender.issue.id.get, f.id))
          }
          </div>
        <div class="panel-footer">
          @if(issueRender.issue.state != IssueState.Closed) {
            @defining(Form(single("message" -> nonEmptyText))){ form: Form[String] =>
              @tags.messages.messageForm(controllers.routes.ClientMessagesController.addMessage(issueRender.issue.id.get), form, supportedMimeTypes, issueRender.issue.id.get, context.user.get.universityId.get)
            }
          } else {
            <p>
              We think this enquiry is now resolved, so we've marked it as closed.
              But if there's anything else you want to ask us about this or any other subject,
              you can always do so just by sending us a
              <a href="@controllers.enquiries.routes.EnquiryController.form()">new enquiry</a>.
            </p>
          }
        </div>
      </div>
    </div>
  }
  </div>
}